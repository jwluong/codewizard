console.log('calling update.js.erb')

var show_area = document.getElementById('show_area');
var result = document.getElementById('result');
var character_avatar = document.getElementById('character_avatar');
var monster = document.getElementById('monster');
var char_status = document.getElementById('status');
var attack = document.getElementById('attack');

// console.log(show_area)
var status = "<%= @status %>";
// console.log(status);
// console.log(character_avatar);
// console.log(character_avatar.style);


var next_question = () => {
  show_area.innerHTML = '<%= j render "questions/show", question: @level.questions[@progress + 1], addBackground: @addBackground %>';
};

var stayhere = () => {
    show_area.innerHTML = '<%= j render "questions/show", question: @level.questions[@progress], addBackground: @addBackground %>';
};

var set_attack = () =>{
  attack.style.visibility = "visible";
  attack.style.top = character_avatar.x + 45  + 'px';
  attack.style.left = character_avatar.y + 243 + 'px';
};

var set_mon_attack = () =>{
  attack.style.visibility = "visible";
  attack.style.transform = 'rotate(180deg)';
  attack.style.top = monster.y +100 + 'px';
  attack.style.left = monster.x  + 'px';
};

var finish_attack = () =>{
  attack.style.visibility = "hidden";
};

var char_attack = (attack_img) => {
  var id = setInterval(frame, 1);
  var pos = character_avatar.x + 105;
    function frame() {
      if (pos > monster.x) {
        clearInterval(id);
      } else {
        pos += 5;
        attack_img.style.left = pos + 'px';
      }
    }
};

var mon_attack = (attack_img) => {
  var id = setInterval(frame, 1);
  var pos = monster.x + 105;
    function frame() {
      if (pos < character_avatar.x+70) {
        clearInterval(id);
      } else {
        pos -= 5;
        attack_img.style.left = pos + 'px';
      }
    }
};
//update character mini status///////////////////////////////////////////////////////////
var update_status = () => {
  console.log("in the update method");
  console.log(char_status);
    char_status.innerHTML = '<%= j render "characters/status" %>';
};

//delay+promise///////////////////////////////////////////////////////////
var delay = (ms) => new Promise(
  (resolve) => setTimeout(resolve, ms)
);

//hurt effect///////////////////////////////////////////////////////////
var disappear = (object) => {
  console.log("in disappear");
  object.style.visibility = "hidden";
  console.log(object.style.visibility);
}

var show = (object) => {
  console.log("in show");
  object.style.visibility = "visible";
  console.log(object.style.visibility);
}

var hurt = (object) => {
  var delay_time = 100;
  delay(1)
    .then(() => {
      disappear(object);
      return delay(delay_time);
    })
    .then(() => {
      show(object);
      return delay(delay_time);
    }).then(() => {
      disappear(object);
      return delay(delay_time);
    })
    .then(() => {
      show(object);
      return delay(delay_time);
    }).then(() => {
      disappear(object);
      return delay(delay_time);
    })
    .then(() => {
      show(object);
      return delay(delay_time);
    });
};
/////////////////////////////////////////////////////////////


//choosing logic///////////////////////////////////////////////////////////
switch(status) {
  case "next":
    console.log("next");
    delay(1)
    .then(() => {
      set_attack();
      return delay(1);
    }).then(() => {
      char_attack(attack);
      return delay(600);
    }).then(() => {
      finish_attack();
      hurt(monster);
      return delay(700);
    }).then(() => {
      next_question();
      return delay(1)
      .then(() => {
      update_status();
      return delay(1); });
    });
    // set_attack(attack);
    // console.log(character_avatar.x);
    // console.log(character_avatar.y);
    // console.log(monster.x);
    // console.log(monster.y);
    break;
  case "result":
    console.log("result");
    result.innerHTML = '<%= j render "gamecontrols/result", addBackground: @addBackground %>';
    break;
  case "stay":
    console.log("stay");
    console.log(monster.x);
    console.log(monster.y);
    // show_area.innerHTML = '<%= j render "questions/show", question: @level.questions[@progress], addBackground: @addBackground %>';
    delay(1)
    .then(() => {
      set_mon_attack();
      return delay(1);
    }).then(() => {
      mon_attack(attack);
      return delay(600);
    }).then(() => {
      finish_attack();
      hurt(character_avatar);
      return delay(700);
    }).then(() => {
      stayhere();
      return delay(1);
    }).then(() => {
      update_status();
      return delay(1);
    });
    break;
  case "town":
    console.log("town");
    result.innerHTML = '<%= j render "gamecontrols/hint", level: @level, addBackground: @addBackground %>';
    break;
}

